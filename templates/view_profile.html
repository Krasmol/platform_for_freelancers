{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card mb-4">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-4">
                    <div class="user-avatar me-4">
                        {% if current_user.is_client %}
                            {{ current_user.username[0] }}
                        {% else %}
                            {{ current_user.profile.full_name[0] if current_user.profile and current_user.profile.full_name else current_user.username[0] }}
                        {% endif %}
                    </div>
                    <div>
                        <h1 class="h2 fw-bold mb-1">
                            {% if current_user.is_client %}
                                {{ current_user.username }}
                            {% else %}
                                {{ current_user.profile.full_name if current_user.profile and current_user.profile.full_name else current_user.username }}
                            {% endif %}
                        </h1>
                        <h4 class="text-primary mb-2">
                            {% if current_user.is_client %}
                                üéØ –ó–∞–∫–∞–∑—á–∏–∫
                            {% else %}
                                {{ current_user.profile.title if current_user.profile and current_user.profile.title else '–§—Ä–∏–ª–∞–Ω—Å–µ—Ä' }}
                            {% endif %}
                        </h4>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success me-2">
                                <i class="bi bi-star-fill me-1"></i>–ü—Ä–æ—Ñ–∏–ª—å –∞–∫—Ç–∏–≤–µ–Ω
                            </span>
                            {% if not current_user.is_client and current_user.profile %}
                            <span class="badge bg-info me-2">
                                ‚≠ê –†–µ–π—Ç–∏–Ω–≥: {{ "%.1f"|format(get_freelancer_rating(current_user.id)) }}/5
                            </span>
                            {% endif %}
                            <span class="text-muted">
                                <i class="bi bi-calendar me-1"></i>
                                –ù–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ —Å {{ current_user.created_at.strftime('%d.%m.%Y') }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- –û —Å–µ–±–µ -->
                {% if not current_user.is_client and current_user.profile and current_user.profile.description %}
                <div class="mb-4">
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-person-lines-fill text-primary me-2"></i>–û —Å–µ–±–µ
                    </h5>
                    <p class="lead">{{ current_user.profile.description }}</p>
                </div>
                {% endif %}

                <!-- –ù–∞–≤—ã–∫–∏ -->
                {% if not current_user.is_client and current_user.profile and current_user.profile.skills %}
                <div class="mb-4">
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-tools text-primary me-2"></i>–ù–∞–≤—ã–∫–∏
                    </h5>
                    <div class="d-flex flex-wrap gap-2">
                        {% for skill in current_user.profile.skills.split(',') %}
                        <span class="badge bg-primary px-3 py-2 fs-6">
                            <i class="bi bi-check-circle me-1"></i>{{ skill.strip() }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="card">
            <div class="card-body">
                <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
                    {% if current_user.is_client %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects" type="button" role="tab">
                            <i class="bi bi-briefcase me-2"></i>–ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">
                            <i class="bi bi-graph-up me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </button>
                    </li>
                    {% else %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="work-tab" data-bs-toggle="tab" data-bs-target="#work" type="button" role="tab">
                            <i class="bi bi-gear me-2"></i>–ú–æ—è —Ä–∞–±–æ—Ç–∞
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
                            <i class="bi bi-star me-2"></i>–û—Ç–∑—ã–≤—ã
                        </button>
                    </li>
                    {% endif %}
                </ul>

                <div class="tab-content" id="profileTabsContent">
                    {% if current_user.is_client %}
                    <!-- –ó–∞–∫–∞–∑—á–∏–∫: –ü—Ä–æ–µ–∫—Ç—ã -->
                    <div class="tab-pane fade show active" id="projects" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold mb-0">–ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h5>
                            <a href="{{ url_for('create_project') }}" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus-circle me-2"></i>–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                            </a>
                        </div>

                        {% if user_projects_active or user_projects_completed %}
                            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã -->
                            {% if user_projects_active %}
                            <h6 class="fw-bold mb-3 text-primary">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                            <th>–ë—é–¥–∂–µ—Ç</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                                            <th>–î–∞—Ç–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for project in user_projects_active %}
                                        <tr>
                                            <td>
                                                <a href="{{ url_for('project_detail', project_id=project.id) }}" class="text-decoration-none">
                                                    {{ project.title }}
                                                </a>
                                            </td>
                                            <td class="text-success fw-bold">{{ project.budget }} ‚ÇΩ</td>
                                            <td>
                                                <span class="badge bg-{% if project.status == 'open' %}success{% else %}warning{% endif %}">
                                                    {{ '–û—Ç–∫—Ä—ã—Ç' if project.status == 'open' else '–í —Ä–∞–±–æ—Ç–µ' }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if project.freelancer %}
                                                {{ project.freelancer.username }}
                                                {% else %}
                                                <span class="text-muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-muted">{{ project.created_at.strftime('%d.%m.%Y') }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}

                            <!-- –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã -->
                            {% if user_projects_completed %}
                            <h6 class="fw-bold mb-3 text-success">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                            <th>–ë—é–¥–∂–µ—Ç</th>
                                            <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                                            <th>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for project in user_projects_completed %}
                                        <tr>
                                            <td>{{ project.title }}</td>
                                            <td class="text-success fw-bold">{{ project.budget }} ‚ÇΩ</td>
                                            <td>
                                                {% if project.freelancer %}
                                                {{ project.freelancer.username }}
                                                {% else %}
                                                <span class="text-muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-muted">{{ project.completed_at.strftime('%d.%m.%Y') if project.completed_at else '-' }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-briefcase display-4 text-muted mb-3"></i>
                            <h5 class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</h5>
                            <p class="text-muted mb-4">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏ –Ω–∞–π–¥–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</p>
                            <a href="{{ url_for('create_project') }}" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- –ó–∞–∫–∞–∑—á–∏–∫: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div class="tab-pane fade" id="stats" role="tabpanel">
                        <h5 class="fw-bold mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑—á–∏–∫–∞</h5>

                        <div class="row text-center mb-4">
                            <div class="col-md-4 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h3>{{ user_projects_active|length + user_projects_completed|length }}</h3>
                                        <p class="mb-0">–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h3>{{ user_projects_completed|length }}</h3>
                                        <p class="mb-0">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h3>{{ total_budget }} ‚ÇΩ</h3>
                                        <p class="mb-0">–û–±—â–∏–π –±—é–¥–∂–µ—Ç</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">–†–µ–π—Ç–∏–Ω–≥ –∫–∞–∫ –∑–∞–∫–∞–∑—á–∏–∫–∞</h6>
                                <div class="text-center">
                                    <div class="display-4 text-warning mb-2">
                                        {% if client_rating > 0 %}
                                            {{ "%.1f"|format(client_rating) }}/5
                                        {% else %}
                                            –ù–µ—Ç –æ—Ü–µ–Ω–æ–∫
                                        {% endif %}
                                    </div>
                                    <div class="rating-stars mb-3">
                                        {% if client_rating > 0 %}
                                            {% for i in range(5) %}
                                                {% if i < client_rating|int %}
                                                    ‚≠ê
                                                {% else %}
                                                    ‚òÜ
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –æ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% else %}
                    <!-- –§—Ä–∏–ª–∞–Ω—Å–µ—Ä: –†–∞–±–æ—Ç–∞ -->
                    <div class="tab-pane fade show active" id="work" role="tabpanel">
                        <h5 class="fw-bold mb-4">–ú–æ—è —Ä–∞–±–æ—Ç–∞</h5>

                        <!-- –ü—Ä–æ–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ -->
                        {% if freelancer_projects_active %}
                        <h6 class="fw-bold mb-3 text-warning">–ü—Ä–æ–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ</h6>
                        <div class="table-responsive mb-4">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–ë—é–¥–∂–µ—Ç</th>
                                        <th>–ó–∞–∫–∞–∑—á–∏–∫</th>
                                        <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in freelancer_projects_active %}
                                    <tr>
                                        <td>
                                            <a href="{{ url_for('project_detail', project_id=project.id) }}" class="text-decoration-none">
                                                {{ project.title }}
                                            </a>
                                        </td>
                                        <td class="text-success fw-bold">{{ project.budget }} ‚ÇΩ</td>
                                        <td>{{ project.client.username }}</td>
                                        <td class="text-muted">{{ project.created_at.strftime('%d.%m.%Y') }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}

                        <!-- –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã -->
                        {% if freelancer_projects_completed %}
                        <h6 class="fw-bold mb-3 text-success">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h6>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–ë—é–¥–∂–µ—Ç</th>
                                        <th>–ó–∞–∫–∞–∑—á–∏–∫</th>
                                        <th>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in freelancer_projects_completed %}
                                    <tr>
                                        <td>{{ project.title }}</td>
                                        <td class="text-success fw-bold">{{ project.budget }} ‚ÇΩ</td>
                                        <td>{{ project.client.username }}</td>
                                        <td class="text-muted">{{ project.completed_at.strftime('%d.%m.%Y') if project.completed_at else '-' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}

                        {% if not freelancer_projects_active and not freelancer_projects_completed %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                            <h5 class="text-muted">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</h5>
                            <p class="text-muted">–ù–∞–π–¥–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø—Ä–æ–µ–∫—Ç –∏ –æ—Ç–∫–ª–∏–∫–Ω–∏—Ç–µ—Å—å!</p>
                            <a href="{{ url_for('projects') }}" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>–ù–∞–π—Ç–∏ –ø—Ä–æ–µ–∫—Ç—ã
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- –§—Ä–∏–ª–∞–Ω—Å–µ—Ä: –û—Ç–∑—ã–≤—ã -->
                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                        <h5 class="fw-bold mb-4">–û—Ç–∑—ã–≤—ã –æ—Ç –∑–∞–∫–∞–∑—á–∏–∫–æ–≤</h5>

                        {% if freelancer_reviews %}
                            {% for review in freelancer_reviews %}
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="fw-bold mb-1">{{ review.project.title }}</h6>
                                            <small class="text-muted">–û—Ç {{ review.reviewer.username }}</small>
                                        </div>
                                        <div class="text-warning">
                                            {% for i in range(review.rating) %}‚≠ê{% endfor %}
                                        </div>
                                    </div>
                                    {% if review.comment %}
                                    <p class="mb-0">{{ review.comment }}</p>
                                    {% endif %}
                                    <small class="text-muted">{{ review.created_at.strftime('%d.%m.%Y') }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-star display-4 text-muted mb-3"></i>
                            <h5 class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</h5>
                            <p class="text-muted">–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –æ—Ç–∑—ã–≤—ã –æ—Ç –∑–∞–∫–∞–∑—á–∏–∫–æ–≤!</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="col-lg-4">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="fw-bold mb-3">
                    <i class="bi bi-graph-up text-primary me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </h5>
                <div class="row text-center">
                    {% if current_user.is_client %}
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-primary mb-1">{{ user_projects_active|length }}</h4>
                            <small class="text-muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-success mb-1">{{ user_projects_completed|length }}</h4>
                            <small class="text-muted">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-primary mb-1">{{ freelancer_projects_active|length }}</h4>
                            <small class="text-muted">–í —Ä–∞–±–æ—Ç–µ</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-success mb-1">{{ freelancer_projects_completed|length }}</h4>
                            <small class="text-muted">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="card">
            <div class="card-body">
                <h5 class="fw-bold mb-3">
                    <i class="bi bi-info-circle text-primary me-2"></i>–î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è
                </h5>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–¢–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞:</span>
                        <strong>
                            {% if current_user.is_client %}
                                üéØ –ó–∞–∫–∞–∑—á–∏–∫
                            {% else %}
                                üíª –§—Ä–∏–ª–∞–Ω—Å–µ—Ä
                            {% endif %}
                        </strong>
                    </div>

                    {% if not current_user.is_client and current_user.profile %}
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–°—Ç–∞–≤–∫–∞ –≤ —á–∞—Å:</span>
                        <strong class="text-success">
                            {% if current_user.profile.hourly_rate %}
                                {{ current_user.profile.hourly_rate }} ‚ÇΩ
                            {% else %}
                                –ù–µ —É–∫–∞–∑–∞–Ω–∞
                            {% endif %}
                        </strong>
                    </div>

                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–û–ø—ã—Ç:</span>
                        <strong>{{ current_user.profile.experience or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</strong>
                    </div>
                    {% endif %}

                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</span>
                        <strong>@{{ current_user.username }}</strong>
                    </div>

                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span class="text-muted">Email:</span>
                        <strong>{{ current_user.email }}</strong>
                    </div>
                </div>

                {% if not current_user.is_client %}
                <div class="d-grid gap-2">
                    {% if current_user.profile %}
                    <button class="btn btn-outline-primary" onclick="alert('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">
                        <i class="bi bi-pencil me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    </button>
                    {% else %}
                    <a href="{{ url_for('create_profile') }}" class="btn btn-primary">
                        <i class="bi bi-person-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.rating-stars {
    font-size: 1.5rem;
}

.user-avatar {
    width: 80px;
    height: 80px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 2rem;
}

.nav-tabs .nav-link.active {
    background-color: #f8f9fa;
    border-bottom-color: #f8f9fa;
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}