{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold mb-0">
                        <i class="bi bi-inbox text-primary me-2"></i>Обращения в поддержку
                    </h2>
                    <div class="badge bg-primary fs-6">{{ tickets|length }} обращений</div>
                </div>

                <!-- Фильтры -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="btn-group">
                            <a href="{{ url_for('admin_tickets') }}?status=all" class="btn btn-outline-primary {% if status_filter == 'all' %}active{% endif %}">
                                Все ({{ tickets|length }})
                            </a>
                            <a href="{{ url_for('admin_tickets') }}?status=open" class="btn btn-outline-warning {% if status_filter == 'open' %}active{% endif %}">
                                Активные
                            </a>
                            <a href="{{ url_for('admin_tickets') }}?status=closed" class="btn btn-outline-success {% if status_filter == 'closed' %}active{% endif %}">
                                Закрытые
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-outline-secondary" onclick="window.location.reload()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Обновить
                        </button>
                    </div>
                </div>

                <!-- Таблица обращений -->
                {% if tickets %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Тема</th>
                                <th>Пользователь</th>
                                <th>Категория</th>
                                <th>Статус</th>
                                <th>Приоритет</th>
                                <th>Дата создания</th>
                                <th>Обновлено</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in tickets %}
                            <tr>
                                <td><strong>#{{ ticket.id }}</strong></td>
                                <td>
                                    <a href="{{ url_for('admin_ticket_detail', ticket_id=ticket.id) }}" class="text-decoration-none fw-bold">
                                        {{ ticket.subject }}
                                    </a>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar me-2" style="width: 30px; height: 30px; font-size: 0.7rem;">
                                            {{ ticket.user.username[0] }}
                                        </div>
                                        {{ ticket.user.username }}
                                    </div>
                                </td>
                                <td>{{ ticket.category }}</td>
                                <td>
                                    <span class="badge bg-{% if ticket.status == 'open' %}warning{% elif ticket.status == 'in_progress' %}info{% elif ticket.status == 'resolved' %}success{% else %}secondary{% endif %}">
                                        {% if ticket.status == 'open' %}Открыт
                                        {% elif ticket.status == 'in_progress' %}В работе
                                        {% elif ticket.status == 'resolved' %}Решен
                                        {% else %}Закрыт{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{% if ticket.priority == 'low' %}success{% elif ticket.priority == 'medium' %}warning{% elif ticket.priority == 'high' %}danger{% else %}dark{% endif %}">
                                        {% if ticket.priority == 'low' %}Низкий
                                        {% elif ticket.priority == 'medium' %}Средний
                                        {% elif ticket.priority == 'high' %}Высокий
                                        {% else %}Срочный{% endif %}
                                    </span>
                                </td>
                                <td class="text-muted">{{ ticket.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                <td class="text-muted">{{ ticket.updated_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('admin_ticket_detail', ticket_id=ticket.id) }}" class="btn btn-outline-primary">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if ticket.status != 'closed' %}
                                        <a href="{{ url_for('admin_ticket_detail', ticket_id=ticket.id) }}" class="btn btn-outline-success">
                                            <i class="bi bi-reply"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox display-4 mb-3"></i>
                    <h3>Обращений нет</h3>
                    <p class="mb-4">Здесь будут отображаться обращения пользователей в поддержку</p>
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-primary">
                        <i class="bi bi-arrow-left me-2"></i>Назад в панель
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.user-avatar {
    width: 30px;
    height: 30px;
    font-size: 0.7rem;
}
</style>

<script>
// Автообновление каждые 30 секунд
setTimeout(() => {
    window.location.reload();
}, 30000);
</script>
{% endblock %}